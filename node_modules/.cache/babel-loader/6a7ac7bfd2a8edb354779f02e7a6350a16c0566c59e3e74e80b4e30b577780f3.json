{"ast":null,"code":"import _objectSpread from\"C:/Users/allen/git/app2-webview/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _regeneratorRuntime from\"C:/Users/allen/git/app2-webview/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"C:/Users/allen/git/app2-webview/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"C:/Users/allen/git/app2-webview/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{useState,useEffect}from'react';import{useDispatch}from'react-redux';import{showCustomPrompt,showError}from'utilities/MessageModal';import{setWaittingVisible}from'stores/reducers/ModalReducer';import Layout from'components/Layout/Layout';import{MainScrollWrapper}from'components/Layout';import BottomAction from'components/BottomAction';import CreditCard from'components/CreditCard';import{closeFunc,loadFuncParams,startFunc}from'utilities/AppScriptProxy';import{FuncID}from'utilities/FuncID';import CreditCardTxsList from'components/CreditCardTxsList';import PageWrapper from'./R00100.style';import{getBankeeCard,getTransactionPromise,updateTxnNotes}from'./api';/**\r\n * R00100 信用卡 即時消費明細\r\n */import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var R00100=function R00100(){var dispatch=useDispatch();var _useState=useState(),_useState2=_slicedToArray(_useState,2),cardInfo=_useState2[0],setCardInfo=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),transactions=_useState4[0],setTransactions=_useState4[1];var go2Instalment=function go2Instalment(){return startFunc(FuncID.R00200,{cardNo:cardInfo.cardNo});};var getTransactions=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(cards){var transactionsArray,flattedTransactions;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return Promise.all(cards.map(function(_ref2){var cardNo=_ref2.cardNo;return getTransactionPromise(cardNo);}));case 2:transactionsArray=_context.sent;flattedTransactions=transactionsArray.flat();// setTransactions(flattedTransactions);\nreturn _context.abrupt(\"return\",flattedTransactions);case 5:case\"end\":return _context.stop();}}},_callee);}));return function getTransactions(_x){return _ref.apply(this,arguments);};}();// 編輯信用卡明細備註的 Handler\nvar onTxnNotesEdit=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(payload){var _yield$updateTxnNotes,result,message;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return updateTxnNotes(payload);case 2:_yield$updateTxnNotes=_context2.sent;result=_yield$updateTxnNotes.result;message=_yield$updateTxnNotes.message;if(result){setTransactions(function(prevTrans){return prevTrans.map(function(tran){return tran.txKey===payload.txKey?_objectSpread(_objectSpread({},tran),{},{note:payload.note}):tran;});});}else showError(message);case 6:case\"end\":return _context2.stop();}}},_callee2);}));return function onTxnNotesEdit(_x2){return _ref3.apply(this,arguments);};}();useEffect(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(){var fetchedCardInfo,fetchedTransactions,funcParams,bankeeCardInfo;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:dispatch(setWaittingVisible(true));fetchedCardInfo=null;fetchedTransactions=null;_context3.next=5;return loadFuncParams();case 5:funcParams=_context3.sent;if(!funcParams){_context3.next=11;break;}fetchedCardInfo=_objectSpread(_objectSpread({},funcParams.card),{},{usedCardLimit:funcParams.usedCardLimit});fetchedTransactions=funcParams.transactions;_context3.next=21;break;case 11:_context3.next=13;return getBankeeCard();case 13:bankeeCardInfo=_context3.sent;if(bankeeCardInfo)fetchedCardInfo=bankeeCardInfo;if(fetchedCardInfo){_context3.next=18;break;}_context3.next=18;return showCustomPrompt({message:'您尚未持有Bankee信用卡，請在系統關閉此功能後，立即申請。',onOk:closeFunc,onClose:closeFunc});case 18:_context3.next=20;return getTransactions(fetchedCardInfo.cards);case 20:fetchedTransactions=_context3.sent;case 21:setCardInfo(fetchedCardInfo);setTransactions(fetchedTransactions);dispatch(setWaittingVisible(false));case 24:case\"end\":return _context3.stop();}}},_callee3);})),[]);return/*#__PURE__*/_jsx(Layout,{title:\"\\u4FE1\\u7528\\u5361\\u5373\\u6642\\u6D88\\u8CBB\\u660E\\u7D30\",goBackFunc:closeFunc,children:/*#__PURE__*/_jsx(MainScrollWrapper,{children:/*#__PURE__*/_jsxs(PageWrapper,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"bg-gray\",children:/*#__PURE__*/_jsx(CreditCard,{cardName:cardInfo!==null&&cardInfo!==void 0&&cardInfo.isBankeeCard?'Bankee信用卡':'所有信用卡',accountNo:cardInfo!==null&&cardInfo!==void 0&&cardInfo.isBankeeCard?cardInfo.cards[0].cardNo:'',balance:cardInfo===null||cardInfo===void 0?void 0:cardInfo.usedCardLimit,color:\"green\",annotation:\"\\u5DF2\\u4F7F\\u7528\\u984D\\u5EA6\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"txn-wrapper\",children:[!!cardInfo&&/*#__PURE__*/_jsx(CreditCardTxsList,{showAll:true,card:cardInfo,transactions:transactions,onTxnNotesEdit:onTxnNotesEdit}),!!(transactions!==null&&transactions!==void 0&&transactions.length)&&/*#__PURE__*/_jsx(\"div\",{className:\"note\",children:\"\\u5BE6\\u969B\\u8ACB\\u6B3E\\u91D1\\u984D\\u4EE5\\u5E33\\u55AE\\u70BA\\u6E96\"})]}),(cardInfo===null||cardInfo===void 0?void 0:cardInfo.isBankeeCard)&&/*#__PURE__*/_jsx(BottomAction,{position:0,children:/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:go2Instalment,children:\"\\u665A\\u9EDE\\u4ED8\"})})]})})});};export default R00100;","map":{"version":3,"names":["useState","useEffect","useDispatch","showCustomPrompt","showError","setWaittingVisible","Layout","MainScrollWrapper","BottomAction","CreditCard","closeFunc","loadFuncParams","startFunc","FuncID","CreditCardTxsList","PageWrapper","getBankeeCard","getTransactionPromise","updateTxnNotes","R00100","dispatch","cardInfo","setCardInfo","transactions","setTransactions","go2Instalment","R00200","cardNo","getTransactions","cards","Promise","all","map","transactionsArray","flattedTransactions","flat","onTxnNotesEdit","payload","result","message","prevTrans","tran","txKey","note","fetchedCardInfo","fetchedTransactions","funcParams","card","usedCardLimit","bankeeCardInfo","onOk","onClose","isBankeeCard","length"],"sources":["C:/Users/allen/git/app2-webview/src/pages/R00100_CCTransaction/R00100.jsx"],"sourcesContent":["import { useState, useEffect } from 'react';\r\nimport { useDispatch } from 'react-redux';\r\n\r\nimport { showCustomPrompt, showError } from 'utilities/MessageModal';\r\nimport { setWaittingVisible } from 'stores/reducers/ModalReducer';\r\nimport Layout from 'components/Layout/Layout';\r\nimport { MainScrollWrapper } from 'components/Layout';\r\nimport BottomAction from 'components/BottomAction';\r\nimport CreditCard from 'components/CreditCard';\r\n\r\nimport { closeFunc, loadFuncParams, startFunc } from 'utilities/AppScriptProxy';\r\nimport { FuncID } from 'utilities/FuncID';\r\nimport CreditCardTxsList from 'components/CreditCardTxsList';\r\nimport PageWrapper from './R00100.style';\r\nimport { getBankeeCard, getTransactionPromise, updateTxnNotes } from './api';\r\n\r\n/**\r\n * R00100 信用卡 即時消費明細\r\n */\r\nconst R00100 = () => {\r\n  const dispatch = useDispatch();\r\n  const [cardInfo, setCardInfo] = useState();\r\n  const [transactions, setTransactions] = useState();\r\n  const go2Instalment = () => startFunc(FuncID.R00200, {cardNo: cardInfo.cardNo});\r\n\r\n  const getTransactions = async (cards) => {\r\n    const transactionsArray = await Promise.all(\r\n      cards.map(({ cardNo }) => getTransactionPromise(cardNo)),\r\n    );\r\n    const flattedTransactions = transactionsArray.flat();\r\n    // setTransactions(flattedTransactions);\r\n    return flattedTransactions;\r\n  };\r\n\r\n  // 編輯信用卡明細備註的 Handler\r\n  const onTxnNotesEdit = async (payload) => {\r\n    const { result, message } = await updateTxnNotes(payload);\r\n    if (result) {\r\n      setTransactions((prevTrans) => prevTrans.map((tran) => (\r\n        tran.txKey === payload.txKey ? {...tran, note: payload.note} : tran)));\r\n    } else showError(message);\r\n  };\r\n\r\n  useEffect(async () => {\r\n    dispatch(setWaittingVisible(true));\r\n    let fetchedCardInfo = null;\r\n    let fetchedTransactions = null;\r\n    const funcParams = await loadFuncParams();\r\n\r\n    if (funcParams) {\r\n      fetchedCardInfo = {...funcParams.card, usedCardLimit: funcParams.usedCardLimit};\r\n      fetchedTransactions = funcParams.transactions;\r\n    } else {\r\n      // 若從更多 (B00600) 頁面進入，會先確認有沒有 bankee 信用卡，查詢的交易明細就會預設以 bankee 信用卡為主\r\n      const bankeeCardInfo = await getBankeeCard();\r\n      if (bankeeCardInfo) fetchedCardInfo = bankeeCardInfo;\r\n      if (!fetchedCardInfo) {\r\n        await showCustomPrompt({\r\n          message: '您尚未持有Bankee信用卡，請在系統關閉此功能後，立即申請。',\r\n          onOk: closeFunc,\r\n          onClose: closeFunc,\r\n        });\r\n      }\r\n      fetchedTransactions = await getTransactions(fetchedCardInfo.cards);\r\n    }\r\n\r\n    setCardInfo(fetchedCardInfo);\r\n    setTransactions(fetchedTransactions);\r\n    dispatch(setWaittingVisible(false));\r\n  }, []);\r\n\r\n  return (\r\n    <Layout title=\"信用卡即時消費明細\" goBackFunc={closeFunc}>\r\n      <MainScrollWrapper>\r\n        <PageWrapper>\r\n          <div className=\"bg-gray\">\r\n            <CreditCard\r\n              cardName={cardInfo?.isBankeeCard ? 'Bankee信用卡' : '所有信用卡'}\r\n              accountNo={cardInfo?.isBankeeCard ? cardInfo.cards[0].cardNo : ''}\r\n              balance={cardInfo?.usedCardLimit}\r\n              color=\"green\"\r\n              annotation=\"已使用額度\"\r\n            />\r\n          </div>\r\n          <div className=\"txn-wrapper\">\r\n            {!!cardInfo && (\r\n            <CreditCardTxsList\r\n              showAll\r\n              card={cardInfo}\r\n              transactions={transactions}\r\n              onTxnNotesEdit={onTxnNotesEdit}\r\n            />\r\n            ) }\r\n            {!!transactions?.length && (<div className=\"note\">實際請款金額以帳單為準</div>)}\r\n          </div>\r\n          {cardInfo?.isBankeeCard && (\r\n            <BottomAction position={0}>\r\n              <button type=\"button\" onClick={go2Instalment}>晚點付</button>\r\n            </BottomAction>\r\n          ) }\r\n        </PageWrapper>\r\n      </MainScrollWrapper>\r\n    </Layout>\r\n  );\r\n};\r\n\r\nexport default R00100;\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}