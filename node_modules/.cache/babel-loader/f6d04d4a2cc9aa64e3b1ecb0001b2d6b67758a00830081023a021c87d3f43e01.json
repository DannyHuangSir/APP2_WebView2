{"ast":null,"code":"import _objectSpread from\"C:/Users/allen/git/app2-webview/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _regeneratorRuntime from\"C:/Users/allen/git/app2-webview/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"C:/Users/allen/git/app2-webview/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"C:/Users/allen/git/app2-webview/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";/* eslint-disable object-curly-newline */import{useEffect,useState}from'react';import{useDispatch}from'react-redux';import{Controller,useForm}from'react-hook-form';import{yupResolver}from'@hookform/resolvers/yup';import*as yup from'yup';import{FEIBButton,FEIBErrorMessage,FEIBInput,FEIBInputLabel}from'components/elements';import PasswordInput from'components/PasswordInput';import CountDown from'components/CountDown';import{otpCodeValidation,passwordValidation}from'utilities/validation';import{showAlert}from'utilities/AppScriptProxy';import e2ee from'utilities/E2ee';import{setDrawerVisible}from'stores/reducers/ModalReducer';import{transactionAuthVerify}from'./api';import PasswordDrawerWrapper from'./passwordDrawer.style';/**\r\n * Web版 交易驗證模組 UI\r\n * @param {*} param0 {\r\n *   authData: {\r\n *     key: 本次要求驗證的金鑰，用來檢核使用者輸入\r\n *     otpSmsId: OTP簡訊中的識別碼。\r\n *     otpMobile: 簡訊識別碼發送的手機門號。\r\n *   },\r\n *   inputPWD: 表示需要使用者輸入密碼。\r\n *   onFinished: 完成時的事件。\r\n *     事件參數 {\r\n *       result: 驗證結果(true/false)。\r\n *       message: 驗證失敗狀況描述。\r\n *     }\r\n * }\r\n */import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var PasswordDrawer=function PasswordDrawer(_ref){var funcCode=_ref.funcCode,authData=_ref.authData,inputPWD=_ref.inputPWD,onFinished=_ref.onFinished;var dispatch=useDispatch();var schema=yup.object().shape({otpCode:authData.otpSmsId?otpCodeValidation():null,password:inputPWD?passwordValidation():null});var _useForm=useForm({resolver:yupResolver(schema)}),handleSubmit=_useForm.handleSubmit,control=_useForm.control,errors=_useForm.formState.errors;var _useState=useState(true),_useState2=_slicedToArray(_useState,2),resendDisabled=_useState2[0],setResendDisabled=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),replayCountDown=_useState4[0],setReplayCountDown=_useState4[1];var handleClickResendButton=function handleClickResendButton(){// TODO 重送OTP\nsetResendDisabled(true);setReplayCountDown(true);// call otp api\n};var handleClickSubmit=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(data){var otpCode,netbankPwd,verifyRs;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:// 驗證 OTP驗證碼 & 網銀密碼\notpCode=data.otpCode;// 使用者輸入的「驗證碼」。\nnetbankPwd=e2ee(data.password);// 使用者輸入的「網銀密碼」，還要再做 E2EE。\n_context.next=4;return transactionAuthVerify({authKey:authData.key,funcCode:funcCode,netbankPwd:netbankPwd,otpCode:otpCode});case 4:verifyRs=_context.sent;// console.log(verifyRs);\nif((verifyRs===null||verifyRs===void 0?void 0:verifyRs.result)===true){// 正常結果。\n// Note 因為之後叫用交易相關 API 時可能會需要用到，所以傳回 E2EE 加密後的 netbankPwd 值。\nonFinished({result:true,message:null,netbankPwd:netbankPwd});dispatch(setDrawerVisible(false));}else{// TODO 處理密碼錯誤的情況，累計三次驗證失敗之後，就傳回驗證失敗; 否則不會結束Promise\nshowAlert(verifyRs===null||verifyRs===void 0?void 0:verifyRs.message);// NOTE 不能用 Layout 中的 Drawer，因為再跳出 Popup Window 後， Drawer 會立即關掉！\n}case 6:case\"end\":return _context.stop();}}},_callee);}));return function handleClickSubmit(_x){return _ref2.apply(this,arguments);};}();useEffect(function(){var timer=setInterval(function(){return setReplayCountDown(false);},1000);return function(){return clearInterval(timer);};},[replayCountDown]);var renderOTPArea=function renderOTPArea(){var _errors$otpCode;return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"countDownArea\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"countDown\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"\\u6642\\u9593\\u5012\\u6578\"}),/*#__PURE__*/_jsx(CountDown,{onEnd:function onEnd(){return setResendDisabled(false);},replay:replayCountDown})]}),/*#__PURE__*/_jsx(FEIBButton,{className:\"resendButton\",disabled:resendDisabled,onClick:handleClickResendButton,children:\"\\u91CD\\u65B0\\u5BC4\\u9A57\\u8B49\\u78BC\"})]}),/*#__PURE__*/_jsxs(FEIBInputLabel,{children:[\"\\u4E00\\u6B21\\u6027 OTP \\u9A57\\u8B49 (\\u767C\\u9001\\u9580\\u865F\\uFF1A\",\"\".concat(authData.otpMobile),\")\"]}),/*#__PURE__*/_jsx(Controller,{name:\"otpCode\",defaultValue:\"\",control:control,render:function render(_ref3){var field=_ref3.field;return/*#__PURE__*/_jsx(FEIBInput,_objectSpread(_objectSpread({},field),{},{type:\"text\",id:\"otpCode\",name:\"otpCode\",placeholder:\"\\u8ACB\\u8F38\\u5165\\u9A57\\u8B49\\u78BC\",error:!!errors.otpCode,startAdornment:/*#__PURE__*/_jsx(\"p\",{className:\"prefixCode\",children:\"\".concat(authData.otpSmsId)})}));}}),/*#__PURE__*/_jsx(FEIBErrorMessage,{children:(_errors$otpCode=errors.otpCode)===null||_errors$otpCode===void 0?void 0:_errors$otpCode.message})]});};var renderPasswordArea=function renderPasswordArea(){var _errors$password;return/*#__PURE__*/_jsx(PasswordInput,{id:\"password\",name:\"password\",control:control,errorMessage:(_errors$password=errors.password)===null||_errors$password===void 0?void 0:_errors$password.message});};return/*#__PURE__*/_jsx(PasswordDrawerWrapper,{children:/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSubmit(handleClickSubmit),children:[authData.otpSmsId&&renderOTPArea(),inputPWD&&renderPasswordArea(),/*#__PURE__*/_jsx(FEIBButton,{type:\"submit\",children:\"\\u9001\\u51FA\"})]})});};PasswordDrawer.defaultProps={authData:null,inputPWD:true,onFinished:null};export default PasswordDrawer;","map":{"version":3,"names":["useEffect","useState","useDispatch","Controller","useForm","yupResolver","yup","FEIBButton","FEIBErrorMessage","FEIBInput","FEIBInputLabel","PasswordInput","CountDown","otpCodeValidation","passwordValidation","showAlert","e2ee","setDrawerVisible","transactionAuthVerify","PasswordDrawerWrapper","PasswordDrawer","funcCode","authData","inputPWD","onFinished","dispatch","schema","object","shape","otpCode","otpSmsId","password","resolver","handleSubmit","control","errors","formState","resendDisabled","setResendDisabled","replayCountDown","setReplayCountDown","handleClickResendButton","handleClickSubmit","data","netbankPwd","authKey","key","verifyRs","result","message","timer","setInterval","clearInterval","renderOTPArea","otpMobile","field","renderPasswordArea","defaultProps"],"sources":["C:/Users/allen/git/app2-webview/src/components/PasswordDrawer/index.js"],"sourcesContent":["/* eslint-disable object-curly-newline */\r\nimport { useEffect, useState } from 'react';\r\nimport { useDispatch } from 'react-redux';\r\nimport { Controller, useForm } from 'react-hook-form';\r\nimport { yupResolver } from '@hookform/resolvers/yup';\r\nimport * as yup from 'yup';\r\nimport {\r\n  FEIBButton, FEIBErrorMessage, FEIBInput, FEIBInputLabel,\r\n} from 'components/elements';\r\nimport PasswordInput from 'components/PasswordInput';\r\nimport CountDown from 'components/CountDown';\r\nimport { otpCodeValidation, passwordValidation } from 'utilities/validation';\r\nimport { showAlert } from 'utilities/AppScriptProxy';\r\nimport e2ee from 'utilities/E2ee';\r\nimport { setDrawerVisible } from 'stores/reducers/ModalReducer';\r\nimport { transactionAuthVerify } from './api';\r\nimport PasswordDrawerWrapper from './passwordDrawer.style';\r\n\r\n/**\r\n * Web版 交易驗證模組 UI\r\n * @param {*} param0 {\r\n *   authData: {\r\n *     key: 本次要求驗證的金鑰，用來檢核使用者輸入\r\n *     otpSmsId: OTP簡訊中的識別碼。\r\n *     otpMobile: 簡訊識別碼發送的手機門號。\r\n *   },\r\n *   inputPWD: 表示需要使用者輸入密碼。\r\n *   onFinished: 完成時的事件。\r\n *     事件參數 {\r\n *       result: 驗證結果(true/false)。\r\n *       message: 驗證失敗狀況描述。\r\n *     }\r\n * }\r\n */\r\nconst PasswordDrawer = ({\r\n  funcCode,\r\n  authData,\r\n  inputPWD,\r\n  onFinished,\r\n}) => {\r\n  const dispatch = useDispatch();\r\n\r\n  const schema = yup.object().shape({\r\n    otpCode: authData.otpSmsId ? otpCodeValidation() : null,\r\n    password: inputPWD ? passwordValidation() : null,\r\n  });\r\n  const { handleSubmit, control, formState: { errors } } = useForm({ resolver: yupResolver(schema) });\r\n  const [resendDisabled, setResendDisabled] = useState(true);\r\n  const [replayCountDown, setReplayCountDown] = useState(false);\r\n\r\n  const handleClickResendButton = () => {\r\n    // TODO 重送OTP\r\n    setResendDisabled(true);\r\n    setReplayCountDown(true);\r\n    // call otp api\r\n  };\r\n\r\n  const handleClickSubmit = async (data) => {\r\n    // 驗證 OTP驗證碼 & 網銀密碼\r\n    const {otpCode} = data; // 使用者輸入的「驗證碼」。\r\n    const netbankPwd = e2ee(data.password); // 使用者輸入的「網銀密碼」，還要再做 E2EE。\r\n    const verifyRs = await transactionAuthVerify({ authKey: authData.key, funcCode, netbankPwd, otpCode });\r\n    // console.log(verifyRs);\r\n    if (verifyRs?.result === true) {\r\n      // 正常結果。\r\n      // Note 因為之後叫用交易相關 API 時可能會需要用到，所以傳回 E2EE 加密後的 netbankPwd 值。\r\n      onFinished({ result: true, message: null, netbankPwd });\r\n      dispatch(setDrawerVisible(false));\r\n    } else {\r\n      // TODO 處理密碼錯誤的情況，累計三次驗證失敗之後，就傳回驗證失敗; 否則不會結束Promise\r\n      showAlert(verifyRs?.message); // NOTE 不能用 Layout 中的 Drawer，因為再跳出 Popup Window 後， Drawer 會立即關掉！\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const timer = setInterval(() => setReplayCountDown(false), 1000);\r\n    return () => clearInterval(timer);\r\n  }, [replayCountDown]);\r\n\r\n  const renderOTPArea = () => (\r\n    <div>\r\n      <div className=\"countDownArea\">\r\n        <div className=\"countDown\">\r\n          <p>時間倒數</p>\r\n          {/* TODO 結束時，詢問重送或取消驗證 */}\r\n          <CountDown onEnd={() => setResendDisabled(false)} replay={replayCountDown} />\r\n        </div>\r\n        <FEIBButton\r\n          className=\"resendButton\"\r\n          disabled={resendDisabled}\r\n          onClick={handleClickResendButton}\r\n        >\r\n          重新寄驗證碼\r\n        </FEIBButton>\r\n      </div>\r\n      {/* eslint-disable-next-line react/jsx-one-expression-per-line */}\r\n      <FEIBInputLabel>一次性 OTP 驗證 (發送門號：{`${authData.otpMobile}`})</FEIBInputLabel>\r\n      <Controller\r\n        name=\"otpCode\"\r\n        defaultValue=\"\"\r\n        control={control}\r\n        render={({ field }) => (\r\n          <FEIBInput\r\n            {...field}\r\n            type=\"text\"\r\n            id=\"otpCode\"\r\n            name=\"otpCode\"\r\n            placeholder=\"請輸入驗證碼\"\r\n            error={!!errors.otpCode}\r\n            startAdornment={<p className=\"prefixCode\">{`${authData.otpSmsId}`}</p>}\r\n          />\r\n        )}\r\n      />\r\n      <FEIBErrorMessage>{errors.otpCode?.message}</FEIBErrorMessage>\r\n    </div>\r\n  );\r\n\r\n  const renderPasswordArea = () => (\r\n    <PasswordInput\r\n      id=\"password\"\r\n      name=\"password\"\r\n      control={control}\r\n      errorMessage={errors.password?.message}\r\n    />\r\n  );\r\n\r\n  return (\r\n    <PasswordDrawerWrapper>\r\n      <form onSubmit={handleSubmit(handleClickSubmit)}>\r\n        { authData.otpSmsId && renderOTPArea() }\r\n        { inputPWD && renderPasswordArea() }\r\n        <FEIBButton type=\"submit\">送出</FEIBButton>\r\n      </form>\r\n    </PasswordDrawerWrapper>\r\n  );\r\n};\r\n\r\nPasswordDrawer.defaultProps = {\r\n  authData: null,\r\n  inputPWD: true,\r\n  onFinished: null,\r\n};\r\n\r\nexport default PasswordDrawer;\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}